name: Build TollGate OS

on:
  workflow_dispatch:
    inputs:
      device_id:
        description: 'Router model'
        required: true
        default: 'glinet_gl-mt6000'
        type: choice
        options:
        - glinet_gl-mt6000
      openwrt_version:
        description: 'OpenWrt version'
        required: true
        default: '24.10.1'
        type: string
      release_channel:
        description: 'Release channel'
        required: true
        default: 'stable'
        type: choice
        options:
        - stable
        - dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build Firmware
      id: build-os
      uses: ./actions/build-os
      with:
        device_id: ${{ inputs.device_id }}
        openwrt_version: ${{ inputs.openwrt_version }}
        tollgate_os_version: v0.0.1
        release_channel: ${{ inputs.release_channel }}
        nostr_secret_key: ${{ secrets.NOSTR_SECRET_KEY }}
        nostr_public_key: ${{ secrets.NOSTR_PUBLIC_KEY }}
        nsec: ${{ secrets.NSEC }}
        nsecbech: ${{ secrets.NSEC_BECH32 }}

    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: tollgate-firmware-${{ inputs.device_id }}
        path: ${{ steps.build-os.outputs.firmware_path }}
        retention-days: 30

    - name: Create Build Summary
      run: |
        echo "## ðŸŽ‰ Trails Coffee Firmware Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Device:** ${{ inputs.device_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**OpenWrt Version:** ${{ inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**TollGate Version:** v0.0.1" >> $GITHUB_STEP_SUMMARY
        echo "**Release Channel:** ${{ inputs.release_channel }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Customizations Included:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ **Whitelisted domains** for Trails Coffee" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”“ **Unrestricted private network** for staff" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¨ **Custom branded captive portal**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¶ **Trails Coffee SSID names**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ **Branded system banner**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Download Your Firmware:" >> $GITHUB_STEP_SUMMARY
        echo "1. **From Artifacts**: Click the 'Artifacts' section below" >> $GITHUB_STEP_SUMMARY
        echo "2. **Download**: \`tollgate-firmware-${{ inputs.device_id }}.zip\`" >> $GITHUB_STEP_SUMMARY
        echo "3. **Extract**: The .bin file from the ZIP" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Flash to Your Router:" >> $GITHUB_STEP_SUMMARY
        echo "**Option A - Use the flash script:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "scp firmware.bin root@192.168.1.1:/tmp/" >> $GITHUB_STEP_SUMMARY
        echo "ssh root@192.168.1.1 'sysupgrade -n /tmp/firmware.bin'" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Option B - Via LuCI web interface:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Connect to router at http://192.168.1.1:8080" >> $GITHUB_STEP_SUMMARY
        echo "2. Go to System â†’ Backup/Flash Firmware" >> $GITHUB_STEP_SUMMARY
        echo "3. Upload and flash the .bin file" >> $GITHUB_STEP_SUMMARY
