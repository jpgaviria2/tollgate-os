name: Build TollGate OS

on:
  workflow_dispatch:
    inputs:
      device_id:
        description: 'Router model'
        required: true
        default: 'glinet_gl-mt6000'
        type: choice
        options:
        - glinet_gl-mt6000
      openwrt_version:
        description: 'OpenWrt version'
        required: true
        default: '24.10.1'
        type: string
      release_channel:
        description: 'Release channel'
        required: true
        default: 'stable'
        type: choice
        options:
        - stable
        - dev

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - name: Build Firmware
      id: build-os
      uses: ./actions/build-os
      with:
        device_id: ${{ inputs.device_id }}
        openwrt_version: ${{ inputs.openwrt_version }}
        tollgate_os_version: v0.0.1
        release_channel: ${{ inputs.release_channel }}
        nostr_secret_key: ${{ secrets.NOSTR_SECRET_KEY }}
        nostr_public_key: ${{ secrets.NOSTR_PUBLIC_KEY }}
        nsec: ${{ secrets.NSEC }}
        nsecbech: ${{ secrets.NSEC_BECH32 }}

    - name: Upload Firmware to Blossom (Primal)
      id: upload_firmware
      uses: Origami74/upload-blossom-action@v0.1.1
      continue-on-error: true
      with:
        host: "https://blossom.primal.net"
        filePath: ${{ steps.build-os.outputs.firmware_path }}
        privatekey: ${{ secrets.NSEC }}

    - name: Publish Firmware NIP-94 Metadata
      if: steps.upload_firmware.outcome == 'success'
      uses: OpenTollGate/nostr-publish-file-metadata-action@v0.1.0
      with:
        relays: wss://relay.damus.io,wss://nos.lol,wss://nostr.mom
        url: ${{ steps.upload_firmware.outputs.url }}
        mimeType: "application/octet-stream"
        fileHash: ${{ steps.upload_firmware.outputs.hash }}
        originalHash: ${{ steps.upload_firmware.outputs.hash }}
        filename: ${{ steps.build-os.outputs.firmware_name }}
        content: "Trails Coffee TollGate OS Firmware for ${{ inputs.device_id }}"
        nsec: ${{ secrets.NSEC }}
        size: 16777216

    - name: Fallback to GitHub Artifacts
      if: steps.upload_firmware.outcome != 'success'
      uses: actions/upload-artifact@v4
      with:
        name: tollgate-firmware-${{ inputs.device_id }}
        path: ${{ steps.build-os.outputs.firmware_path }}
        retention-days: 30

    - name: Create Build Summary
      run: |
        echo "## ðŸŽ‰ Trails Coffee Firmware Build Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Device:** ${{ inputs.device_id }}" >> $GITHUB_STEP_SUMMARY
        echo "**OpenWrt Version:** ${{ inputs.openwrt_version }}" >> $GITHUB_STEP_SUMMARY
        echo "**TollGate Version:** v0.0.1" >> $GITHUB_STEP_SUMMARY
        echo "**Release Channel:** ${{ inputs.release_channel }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Customizations Included:" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŒ **Whitelisted domains** for Trails Coffee" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ”“ **Unrestricted private network** for staff" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸŽ¨ **Custom branded captive portal**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ“¶ **Trails Coffee SSID names**" >> $GITHUB_STEP_SUMMARY
        echo "- ðŸ·ï¸ **Branded system banner**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Download Your Firmware:" >> $GITHUB_STEP_SUMMARY

        if [ "${{ steps.upload_firmware.outcome }}" == "success" ]; then
          echo "1. **From Primal Blossom**: ${{ steps.upload_firmware.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "2. **Alternative**: Check Artifacts section below" >> $GITHUB_STEP_SUMMARY
        else
          echo "1. **From Artifacts**: Click the 'Artifacts' section below" >> $GITHUB_STEP_SUMMARY
          echo "2. **Download**: \`tollgate-firmware-${{ inputs.device_id }}.zip\`" >> $GITHUB_STEP_SUMMARY
          echo "3. **Extract**: The .bin file from the ZIP" >> $GITHUB_STEP_SUMMARY
          echo "_Note: Blossom upload failed, using GitHub artifacts instead_" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸš€ Flash to Your Router:" >> $GITHUB_STEP_SUMMARY
        echo "**Option A - Use the flash script:**" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
        echo "scp firmware.bin root@192.168.1.1:/tmp/" >> $GITHUB_STEP_SUMMARY
        echo "ssh root@192.168.1.1 'sysupgrade -n /tmp/firmware.bin'" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Option B - Via LuCI web interface:**" >> $GITHUB_STEP_SUMMARY
        echo "1. Connect to router at http://192.168.1.1:8080" >> $GITHUB_STEP_SUMMARY
        echo "2. Go to System â†’ Backup/Flash Firmware" >> $GITHUB_STEP_SUMMARY
        echo "3. Upload and flash the .bin file" >> $GITHUB_STEP_SUMMARY
